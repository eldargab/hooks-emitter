var should = require('should')
var Emitter = require('..')

describe('Hooks emitter', function() {
  var emitter, calls

  beforeEach(function () {
    emitter = new Emitter
    calls = []
  })

  describe('.on(event, fn)', function() {
    it('should add listeners', function() {
      emitter.on('foo', function(val) {
        calls.push('one', val)
      })
      emitter.on('foo', function(val) {
        calls.push('two', val)
      })

      emitter.emit('foo', 1)
      emitter.emit('bar', 1)
      emitter.emit('foo', 2)

      calls.should.eql(['one', 1, 'two', 1, 'one', 2, 'two', 2])
    })
  })

  describe('.once(event, fn)', function() {
    it('should add a single-shot listener', function (){
      emitter.once('foo', function(val) {
        calls.push('one', val)
      })

      emitter.emit('foo', 1)
      emitter.emit('foo', 2)
      emitter.emit('foo', 3)
      emitter.emit('bar', 1)

      calls.should.eql(['one', 1])
    })
  })

  describe('.off(event, fn)', function() {
    it('should remove a listener', function() {
      function one() { calls.push('one'); }
      function two() { calls.push('two'); }

      emitter.on('foo', one)
      emitter.on('foo', two)
      emitter.off('foo', two)

      emitter.emit('foo')

      calls.should.eql(['one'])
    })

    it('should work with .once()', function() {
      var emitter = new Emitter
      var calls = []

      function one() { calls.push('one'); }

      emitter.once('foo', one)
      emitter.off('foo', one)

      emitter.emit('foo')

      calls.should.eql([])
    })

    it('should work when called from an event', function() {
      var called = false
      function b () {
        called = true
      }
      emitter.on('tobi', function () {
        emitter.off('tobi', b)
      })
      emitter.on('tobi', b)
      emitter.emit('tobi')
      called.should.be.true
      called = false
      emitter.emit('tobi')
      called.should.be.false
    })
  })

  describe('.off(event)', function(){
    it('should remove all listeners for an event', function() {
      var emitter = new Emitter
      var calls = []

      function one() { calls.push('one'); }
      function two() { calls.push('two'); }

      emitter.on('foo', one)
      emitter.on('foo', two)
      emitter.off('foo')

      emitter.emit('foo')
      emitter.emit('foo')

      calls.should.eql([])
    })
  })

  describe('.listeners(event)', function() {
    describe('when handlers are present', function() {
      it('should return an array of callbacks', function() {
        var emitter = new Emitter
        function foo(){}
        emitter.on('foo', foo)
        var l = emitter.listeners('foo')
        l.should.be.an.instanceOf(Array)
        l.length.should.equal(1)
        l[0].should.equal(foo)
      })
    })

    describe('when no handlers are present', function() {
      it('should return an empty array', function() {
        var emitter = new Emitter
        emitter.listeners('foo').should.eql([])
      })
    })
  })

  describe('.hasListeners(event)', function(){
    describe('when handlers are present', function() {
      it('should return true', function(){
        var emitter = new Emitter
        emitter.on('foo', function(){})
        emitter.hasListeners('foo').should.be.true
      })
    })

    describe('when no handlers are present', function() {
      it('should return false', function() {
        var emitter = new Emitter
        emitter.hasListeners('foo').should.be.false
      })
    })
  })

  describe('supports subscriptions on prototype', function() {
    it('should call inherited and self listeners', function() {
      var proto = new Emitter
      var emitter = Object.create(proto)

      proto.on('foo', function () {
        calls.push('proto')
      })

      emitter.on('foo', function () {
        calls.push('emitter')
      })

      emitter.emit('foo')

      calls.should.eql(['proto', 'emitter'])
    })

    it('should not touch proto object', function() {
      var proto = new Emitter
      var emitter = Object.create(proto)

      proto.on('foo', function () {})
      emitter.listeners('foo').length.should.equal(1)
      emitter.off('foo')
      emitter.listeners('foo').length.should.equal(0)
      proto.listeners('foo').length.should.equal(1)
    })
  })

  describe('Emitter(obj)', function() {
    it('should mixin', function(done) {
      var proto = {}
      Emitter(proto)
      proto.on('something', done)
      proto.emit('something')
    })
  })
})

